---
title: "Trabalho Final - Estatística Espacial"
author: "Alexandre Novaes Dornelas, José Carlos Maria Júnior, Thiago Itamar Plum, Walter Alves Moreira Barbosa dos Santos, William Xavier dos Santos, Ygor Silva Nascimento Coelho"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

# Desenvolvimento do Trabalho

Neste documento, realizamos o carregamento das bibliotecas, a importação dos dados, a análise visual e os testes de autocorrelação espacial (Moran Global e Local).

```{r processamento_total, echo=TRUE, message=FALSE, warning=FALSE}
# 1. CARREGAMENTO DE BIBLIOTECAS
library(sf)          
library(readxl)
library(dplyr)       
library(ggplot2)     
library(tmap)
library(stringr)
library(spdep) # Essencial para cálculos de vizinhança e Moran

# 2. IMPORTAÇÃO DOS DADOS (PASTA DADOS)
# Os arquivos devem estar dentro da pasta 'dados' no diretório do projeto
prices_df <- read_excel("dados/base preco propriedade.xlsx")
glasgow_sf <- st_read("dados/Glasgow.shp", quiet = TRUE)

# 2.1 Verificação básica
st_crs(glasgow_sf)
head(prices_df)

# 3. JUNÇÃO E TRATAMENTO
# Unindo as bases pela coluna IZ (Shapefile à esquerda para manter geometria)
glasgow_dados <- left_join(x = glasgow_sf, 
                           y = prices_df, 
                           by = c("IZ" = "IZ"))

# Adicionando rótulo customizado para os popups
glasgow_dados <- glasgow_dados %>% 
  mutate(rotulo = str_c(name, " - £", preco))

# 4. QUESTÃO 1: MAPA ESTÁTICO (AMPLITUDES IGUAIS)
tmap_mode("plot")

tm_shape(shp = glasgow_dados) +
  tm_polygons(
    fill = "preco",
    fill.scale = tm_scale_intervals(style = "equal", n = 5, values = "brewer.greens"),
    fill.legend = tm_legend(title = "Preço Médio (Amplitudes Iguais)")
  ) +
  tm_layout(frame = FALSE, main.title = "Questão 1: Distribuição de Preços")

# 5. QUESTÃO 2: MAPA INTERATIVO (QUANTIS)
tmap_mode("view") 

tm_shape(shp = glasgow_dados) + 
  tm_polygons(
    fill = "preco",
    fill.scale = tm_scale_intervals(style = "quantile", n = 8, values = "matplotlib.blues"), 
    fill.legend = tm_legend(title = "Preço Mediano"),
    id = "rotulo",
    popup.vars = c("Área" = "name", "Preço" = "preco"),
    lwd = 0.25
  )

# 6. QUESTÃO 3: MATRIZ DE VIZINHANÇA
# Definindo vizinhos por contiguidade Queen
vizinhos <- poly2nb(glasgow_dados, queen = TRUE)

# Conversão para lista de pesos padronizada (estilo W)
pesos_espaciais <- nb2listw(vizinhos, style = "W")

summary(vizinhos)

# 7. QUESTÃO 4: AUTOCORRELAÇÃO GLOBAL (I DE MORAN)
# H0: Aleatoriedade Espacial | H1: Existência de Autocorrelação
moran_global <- moran.test(glasgow_dados$preco, pesos_espaciais)
moran_global

# 8. QUESTÃO 5: AUTOCORRELAÇÃO LOCAL (LISA)
tmap_mode("plot")

# Cálculo do Moran Local
lisa_local <- localmoran(glasgow_dados$preco, pesos_espaciais)

# Adicionando o p-valor ao dataframe para mapeamento
glasgow_dados$p_valor_local <- lisa_local[, 5]

tm_shape(glasgow_dados) +
  tm_polygons(
    fill = "p_valor_local",
    fill.scale = tm_scale_intervals(breaks = c(0, 0.05, 1), values = c("red", "white")),
    fill.legend = tm_legend(title = "P-valor < 0.05")
  ) +
  tm_layout(main.title = "Questão 5: Mapa de Significância (LISA)", frame = FALSE)
